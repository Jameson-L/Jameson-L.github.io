<!DOCTYPE html>
<html>
<head>
    <title>Project 3</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <h1>Project 3: (Auto)stitching and Photo Mosaics</h1>
    <h2>Jameson Liu</h2>

    <h3>Part A: Image Warping and Mosaicing</h3>

    <h4>Part A.1: Shoot the Pictures</h4>
    <p>
        I shot photos around campus with the same center of projection (the camera was only rotated, not translated). This enables me to make a panoramic image by stitching the photos together.
    </p>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/doe_left.jpg">
            <p><em>Doe (left)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/doe_middle.jpg">
            <p><em>Doe (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/doe_right.jpg">
            <p><em>Doe (right)</em></p>
        </div>
    </div>
    <br>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/hearst_left.jpg">
            <p><em>Hearst (left)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_middle.jpg">
            <p><em>Hearst (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_right.jpg">
            <p><em>Hearst (right)</em></p>
        </div>
    </div>
    <br>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/campanile_top.jpg">
            <p><em>Campanile (top)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/campanile_middle.jpg">
            <p><em>Campanile (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/campanile_bottom.jpg">
            <p><em>Campanile (bottom)</em></p>
        </div>
    </div>
    
    <h4>Part A.2: Recover Homographies</h4>
    <p>
        The transformation as a result of rotating a camera can be expressed by a homography.
        A homography consists of 8 degrees of freedom (unknowns), so a minimum number of 4 correspondences (2 coordinates each) are needed to solve for a homography using a system of linear equations.
        However, due to noise, it is recommended to use more points. This results in an overdetermined system, which is then solvable via least-squares. 
        I picked several correspondences for each image pair using <a href="https://cal-cs180.github.io/fa23/hw/proj3/tool.html" a> this tool </a>.
        <br><br>
        Below is an example of correspondences between the left and middle images of Doe, with a walkthrough of how the homography is computed:
    </p>
    </div>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/doe_left_correspondences.jpg">
            <p><em>Doe Correspondences (left)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/doe_middle_correspondences.jpg">
            <p><em>Doe Correspondences (middle)</em></p>
        </div>
    </div>
    <p>
        Given a point correspondence \((x, y) \sim (u, v)\), the homography relates them as:

        \[
            H \begin{bmatrix} x \\ y \\ 1 \end{bmatrix} \sim \begin{bmatrix} u \\ v \\ 1 \end{bmatrix}, \quad
            H = \begin{bmatrix}
                h_{11} & h_{12} & h_{13} \\
                h_{21} & h_{22} & h_{23} \\
                h_{31} & h_{32} & h_{33}
            \end{bmatrix}
        \]

        This can be restructured into two equations (per correspondence):

        \[
            \begin{aligned}
                x h_{11} + y h_{12} + 1 \cdot h_{13} + 0 \cdot h_{21} + 0 \cdot h_{22} + 0 \cdot h_{23} - u x h_{31} - u y h_{32} &= u \\
                0 \cdot h_{11} + 0 \cdot h_{12} + 0 \cdot h_{13} + x h_{21} + y h_{22} + 1 \cdot h_{23} - v x h_{31} - v y h_{32} &= v
            \end{aligned}
        \]

        \[
            \underbrace{
                \begin{bmatrix}
                    x & y & 1 & 0 & 0 & 0 & -u x & -u y \\
                    0 & 0 & 0 & x & y & 1 & -v x & -v y
                \end{bmatrix}
            }_{A_i}
            \begin{bmatrix} 
                h_{11} \\ h_{12} \\ h_{13} \\ h_{21} \\ h_{22} \\ h_{23} \\ h_{31} \\ h_{32} 
            \end{bmatrix}
            =
            \underbrace{
                \begin{bmatrix} u \\ v \end{bmatrix}
            }_{b_i}
        \]

        Stacking all correspondences gives \(A h \sim b\) (solved via least-squares when overdetermined). We want to transform the left and right images to the middle:

        \[
            A_\text{left} \, h_\text{left} \sim b_\text{middle} , \quad A_\text{right} \, h_\text{right} \sim b_\text{middle} 
        \]

        Doe Left to Middle:

        \[
            A_\text{left} =
            \begin{bmatrix}
                392 & 454 & 1 & 0 & 0 & 0 & -64288 & -74456 \\
                0 & 0 & 0 & 392 & 454 & 1 & -173656 & -201122 \\
                515 & 266 & 1 & 0 & 0 & 0 & -161195 & -83258 \\
                0 & 0 & 0 & 515 & 266 & 1 & -129780 & -67032 \\
                535 & 260 & 1 & 0 & 0 & 0 & -178690 & -86840 \\
                0 & 0 & 0 & 535 & 260 & 1 & -131610 & -63960 \\
                554 & 267 & 1 & 0 & 0 & 0 & -195562 & -94251 \\
                0 & 0 & 0 & 554 & 267 & 1 & -141270 & -68085 \\
                510 & 442 & 1 & 0 & 0 & 0 & -151470 & -131274 \\
                0 & 0 & 0 & 510 & 442 & 1 & -221340 & -191828 \\
                636 & 374 & 1 & 0 & 0 & 0 & -275388 & -161942 \\
                0 & 0 & 0 & 636 & 374 & 1 & -235320 & -138380 \\
                802 & 474 & 1 & 0 & 0 & 0 & -461952 & -273024 \\
                0 & 0 & 0 & 802 & 474 & 1 & -376940 & -222780 \\
                557 & 547 & 1 & 0 & 0 & 0 & -189937 & -186527 \\
                0 & 0 & 0 & 557 & 547 & 1 & -301894 & -296474 \\
                737 & 502 & 1 & 0 & 0 & 0 & -381766 & -260036 \\
                0 & 0 & 0 & 737 & 502 & 1 & -366289 & -249494 \\
                518 & 478 & 1 & 0 & 0 & 0 & -157990 & -145790 \\
                0 & 0 & 0 & 518 & 478 & 1 & -243460 & -224660
            \end{bmatrix}, \quad
            b_\text{left} =
            \begin{bmatrix}
                164 \\ 443 \\ 313 \\ 252 \\ 334 \\ 246 \\ 353 \\ 255 \\
                297 \\ 434 \\ 433 \\ 370 \\ 576 \\ 470 \\ 341 \\ 542 \\ 518 \\ 497 \\ 305 \\ 470
            \end{bmatrix}
        \]

        \[
            H_\text{left} =
            \begin{bmatrix}
                1.536 & -0.059 & -375.143 \\
                0.262 & 1.348 & -172.870 \\
                0.001 & 0 & 1
            \end{bmatrix}
        \]
    </p>

    <h4>Part A.3: Warp the Images</h4>
    <p>
        By selecting corners of images of objects that should be rectangular and then computing a homography between those corners and a true rectangle (coordinates-wise), 
        I can effectively rectify the image and transform it into a proper rectangle. 
        When using inverse warping, there are two methods to interpolate pixels:
    </p>
    <ul>
        <li>
            <b>Nearest Neighbor Interpolation</b>
            This method simply fetches the value of the nearest pixel.
        </li>
        <li>
            <b>Bilinear Interpolation</b>
            This method computes a weighted average of the 4 surrounding corner pixels.  
        </li>
    </ul>
    <p>
        While bilinear interpolation is slightly slower (not noticeable for small images), I found that my results were better with it.
        For example, for the recycling bin, the text in the rectified image is more legibile when I use bilinear interpolation. 
    </p>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/recycle.jpg">
            <p><em>Recycling Bin</em></p>
        </div>
        <div class="img-item">
            <img src="assets/recycle_rectified_nn.jpg">
            <p><em>Recycling Bin Rectified (NN)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/recycle_rectified_bilinear.jpg">
            <p><em>Recycling Bin Rectified (Bilinear)</em></p>
        </div>
    </div>
    <br>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/keyboard.jpg">
            <p><em>Keyboard</em></p>
        </div>
        <div class="img-item">
            <img src="assets/keyboard_rectified_nn.jpg">
            <p><em>Keyboard Rectified (NN)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/keyboard_rectified_bilinear.jpg">
            <p><em>Keyboard Rectified (Bilinear)</em></p>
        </div>
    </div>

    <h4>Part A.4: Blend the Images into a Mosaic</h4>
    <p>
        With the computed homographies between images, I am then able to project transformed images onto a common plane then stitch them together to form a continuous panoramic image. 
        For the following examples, I picked the middle image to be the reference plane, and warped the surrounding images toward it.
        However, there is an issue of how to handle overlapping regions. 
        With a simple alpha mask (averaging overlapping regions), seams are still relatively visible. 
        By using a weighted-average alpha mask that drops off linearly from the center of an image (until 0 at the corners), I achieved much smoother results, and seams became virtually invisible. 
    </p>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/hearst_mosaic_unsmooth.jpg">
            <p><em>Hearst Mosaic (simple blending)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_mosaic_smooth.jpg">
            <p><em>Hearst Mosaic (smooth blending)</em></p>
        </div>
    </div>
    <br>
    <div class="img-group">
        <div class="img-item">
                <img src="assets/doe_mosaic_smooth.jpg">
                <p><em>Doe Mosaic</em></p>
        </div>
    </div>
    <br>
    <div class="img-item">
        <img src="assets/campanile_mosaic_smooth.jpg">
        <p><em>Campanile Mosaic</em></p>
    </div>

    <h3>Part B: Feature Matching for Autostitching</h3>

    <h4>Part B.1: Harris Corner Detection</h4>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/hearst_middle_harris.jpg">
            <p><em>Hearst Harris Corners (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_middle_anms.jpg">
            <p><em>Hearst ANMS Corners (middle)</em></p>
        </div>
    </div>

    <h4>Part B.2: Feature Descriptor Extraction</h4>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/hearst_middle_descriptor_0.jpg">
            <p><em>Hearst Descriptor 0 (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_middle_descriptor_1.jpg">
            <p><em>Hearst Descriptor 1 (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_middle_descriptor_2.jpg">
            <p><em>Hearst Descriptor 2 (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_middle_descriptor_3.jpg">
            <p><em>Hearst Descriptor 3 (middle)</em></p>
        </div>
    </div>

    <h4>Part B.3: Feature Matching</h4>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/hearst_left_descriptor_1.jpg">
            <p><em>Hearst Descriptor 1 (left)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_left_descriptor_2.jpg">
            <p><em>Hearst Descriptor 2 (left)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_right_descriptor_1.jpg">
            <p><em>Hearst Descriptor 1 (right)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_right_descriptor_6.jpg">
            <p><em>Hearst Descriptor 6 (right)</em></p>
        </div>
    </div>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/hearst_middle_descriptor_146.jpg">
            <p><em>Hearst Descriptor 146 (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_middle_descriptor_0.jpg">
            <p><em>Hearst Descriptor 0 (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_middle_descriptor_233.jpg">
            <p><em>Hearst Descriptor 233 (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_middle_descriptor_66.jpg">
            <p><em>Hearst Descriptor 66 (middle)</em></p>
        </div>
    </div>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/hearst_left_matches.jpg">
            <p><em>Hearst Matches (left)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_middle_l_matches.jpg">
            <p><em>Hearst Matches (middle)</em></p>
        </div>
    </div>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/hearst_middle_r_matches.jpg">
            <p><em>Hearst Matches (middle)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_right_matches.jpg">
            <p><em>Hearst Matches (right)</em></p>
        </div>
    </div>

    <h4>Part B.4: RANSAC for Robust Homography</h4>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/hearst_mosaic_smooth.jpg">
            <p><em>Hearst Mosaic (manual)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/hearst_mosaic_ransac.jpg">
            <p><em>Hearst Mosaic (RANSAC)</em></p>
        </div>
    </div>
    <br>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/doe_mosaic_smooth.jpg">
            <p><em>Doe Mosaic (manual)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/doe_mosaic_ransac.jpg">
            <p><em>Doe Mosaic (RANSAC)</em></p>
        </div>
    </div>
    <br>
    <div class="img-group">
        <div class="img-item">
            <img src="assets/campanile_mosaic_smooth.jpg">
            <p><em>Campanile Mosaic (manual)</em></p>
        </div>
        <div class="img-item">
            <img src="assets/campanile_mosaic_ransac.jpg">
            <p><em>Campanile Mosaic (RANSAC)</em></p>
        </div>
    </div>
</body>
</html>
